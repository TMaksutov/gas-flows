<!-- simulator.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) with consent -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MYJRPRS3TW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    
    // Set default consent state
    gtag('consent', 'default', {
      'analytics_storage': 'denied'
    });
    
    gtag('js', new Date());
    gtag('config', 'G-MYJRPRS3TW');
  </script>
  <meta charset="utf-8">
  <title>Gasfluss-Simulator</title>
  <link rel="canonical" href="https://gas-flows.com/simulator.html">
  <meta name="description" content="Gasfluss-Simulation. Interaktives Erdgas-Pipeline-Simulations- und Flussberechnungstool. Visualisieren Sie Gasverteilung, Gasflussschemata und Pipelinenetze in Echtzeit.">
  <meta name="keywords" content="
    Gaspipeline-Simulation, Pipeline-Berechnung, Pipelinenetzwerk-Graph,
    Gasfluss-Visualisierung, Gasfluss-Schema,
    Methan-Verteilung, Cytoscape.js-Simulation, Echtzeit-Gas-Simulation,
	Gas-Simulation online, Gasdruck-Simulation kostenlos, Gasfluss-Simulator kostenlos online">
<link rel="apple-touch-icon" sizes="57x57" href="../icons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../icons/apple-icon-60x60.png">
<link rel="icon" type="image/png" sizes="16x16" href="../icons/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="36x36" href="../icons/android-icon-36x36.png">
<link rel="icon" type="image/png" sizes="48x48" href="../icons/android-icon-48x48.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="stylesheet" href="../common.css">
  

  <!-- Cytoscape -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.22.0/cytoscape.min.js"></script>
</head>
<body>
  <div class="lang-switcher"><select onchange="window.location.href=this.value"><option value="../index.html">EN</option><option value="index.html" selected>DE</option><option value="../ru/index.html">RU</option></select></div>
  <nav>
    <ul>
      <li><a href="index.html">Flussrechner</a></li>
      <li><a href="pressures.html">Einheiten-Umrechner</a></li>
      <li><a href="aga8.html">AGA8 Z-Faktor</a></li>
      <li><a href="AGA8Flow.html">AGA8 Fluss</a></li>
      <li><a href="simulator.html" class="active">Gas-Simulator</a></li>
      <li><a href="contacts.html">Kontakte</a></li>
    </ul>
  </nav>
  <!-- Controls area (800px wide, centered) -->
  <div id="controls">
    <button id="buildBtn" class="controlButton" title="Erstellen-Modus aktivieren zum Erstellen und Bearbeiten des Netzwerks">ğŸ”¨ Erstellen</button>
    <button id="clearBtn" class="controlButton" title="Alle Knoten und Rohre aus dem Netzwerk lÃ¶schen">âŒ</button>
    <button id="recoverButton" class="controlButton" title="Das zuletzt gespeicherte Netzwerk wiederherstellen">ğŸ”„ </button>
    <button id="RandomBtn" class="controlButton" title="Ein zufÃ¤lliges Netzwerk fÃ¼r Tests generieren">ğŸ² </button>

    <button class="controlButton"></button>

    <button id="simulateBtn" class="controlButton" title="Simulationsmodus aktivieren zur Gasflussanalyse">âš¡ Starten</button>

    <button id="pauseBtn" class="controlButton" title="Simulation pausieren">â¸ï¸</button>
    <button id="playBtn" class="controlButton" title="Simulation in Echtzeit ausfÃ¼hren (Sekunden)">â–¶ï¸</button>
    <button id="playMinBtn" class="controlButton" title="Simulation mit erhÃ¶hter Geschwindigkeit ausfÃ¼hren (Minuten)">â©</button>
    <button id="playHourBtn" class="controlButton" title="Simulation mit maximaler Geschwindigkeit ausfÃ¼hren (Stunden)">â­ï¸</button>
    <button id="resetButton" class="controlButton" title="Simulation auf Anfangszustand zurÃ¼cksetzen">â†º </button>
    <button id="csvButton" class="controlButton" title="Simulationsdaten in CSV-Datei exportieren">ğŸ“ˆ</button>

    <button class="controlButton"></button>

    <button id="exportButton" class="controlButton" title="Aktuelles Netzwerk in Datei exportieren">ğŸ’¾ </button>
    <button id="importButton" class="controlButton" title="Netzwerk aus Datei importieren">ğŸ“ </button>
    <button id="helpButton" class="controlButton" title="Hilfedokumentation Ã¶ffnen">â“ </button>
  </div>


  <script>
    // globals for UI-mode
    let uiMode   = 'build';    // 'build' or 'simulate'
    let simState = 'pause';    // 'pause', 'play_sec', 'play_min', 'play_hour'
  
    function updateControlButtons() {
      const btns = [
        'buildBtn','simulateBtn','clearBtn','RandomBtn',
        'playBtn','playMinBtn','playHourBtn',
        'pauseBtn','resetButton','csvButton','exportButton','importButton','recoverButton'
      ].map(id => document.getElementById(id));
      btns.forEach(b => b.classList.remove('active','deactivated'));
  
      if (uiMode === 'build') {
        document.getElementById('buildBtn').classList.add('active');
        document.getElementById('clearBtn').classList.remove('deactivated');
        document.getElementById('RandomBtn').classList.remove('deactivated');
        document.getElementById('recoverButton').classList.remove('deactivated');
        ['playBtn','playMinBtn','playHourBtn','pauseBtn','resetButton']
          .forEach(id => document.getElementById(id).classList.add('deactivated'));
        document.getElementById('simulateBtn').classList.remove('deactivated');
        
        // Export/Import buttons always available
        ['exportButton','importButton'].forEach(id => 
          document.getElementById(id).classList.remove('deactivated'));
        
        // CSV button state based on data availability
        if (window.updateCSVButtonState) {
          window.updateCSVButtonState();
        }
      } else {
        document.getElementById('simulateBtn').classList.add('active');
        document.getElementById('clearBtn').classList.add('deactivated');
        document.getElementById('RandomBtn').classList.add('deactivated');
        document.getElementById('recoverButton').classList.add('deactivated');
        ['playBtn','playMinBtn','playHourBtn','pauseBtn','resetButton','buildBtn']
          .forEach(id => document.getElementById(id).classList.remove('deactivated'));
        
        // Export/Import buttons always available
        ['exportButton','importButton'].forEach(id => 
          document.getElementById(id).classList.remove('deactivated'));
        
        // CSV button state based on data availability
        if (window.updateCSVButtonState) {
          window.updateCSVButtonState();
        }
        
        if (simState === 'pause')      document.getElementById('pauseBtn').classList.add('active');
        if (simState === 'play_sec')   document.getElementById('playBtn').classList.add('active');
        if (simState === 'play_min')   document.getElementById('playMinBtn').classList.add('active');
        if (simState === 'play_hour')  document.getElementById('playHourBtn').classList.add('active');
      }
    }
  
    function setUIMode(m) {
      uiMode = m;
      // persist UI mode
      localStorage.setItem('uiMode', m);
      if (m === 'build') {
        setSimState('pause');
      }
      updateControlButtons();
    }
  
    function setSimState(s) {
      simState = s;
      // persist simulation state
      localStorage.setItem('simState', s);
      updateControlButtons();
    }
  
    // wire up your controls
    document.getElementById('buildBtn').addEventListener('click', () => {
      setUIMode('build');
      setSimulationMode('stop', cy, updateInfo);
      // Don't reset simulation data - preserve pressures and injections
    });
    document.getElementById('simulateBtn').addEventListener('click', () => {
      setUIMode('simulate');
      setSimState('pause');
      setSimulationMode('stop', cy, updateInfo);
    });
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (uiMode !== 'build') return;
      clearGraph();
      setUIMode('build');
      setSimulationMode('stop', cy, updateInfo);
    });
    document.getElementById('RandomBtn').addEventListener('click', () => {
      if (uiMode !== 'build') return;
      if (window.generateRandomNetwork) {
        generateRandomNetwork();
      } else {
        console.error('Random network generation function not available.');
      }
      setUIMode('build');
      setSimulationMode('stop', cy, updateInfo);
    });
    document.getElementById('playBtn').addEventListener('click', () => {
      if (uiMode !== 'simulate') return;
      setSimulationMode('sec', cy, updateInfo);
      setSimState('play_sec');
    });
    document.getElementById('playMinBtn').addEventListener('click', () => {
      if (uiMode !== 'simulate') return;
      setSimulationMode('min', cy, updateInfo);
      setSimState('play_min');
    });
    document.getElementById('playHourBtn').addEventListener('click', () => {
      if (uiMode !== 'simulate') return;
      setSimulationMode('hour', cy, updateInfo);
      setSimState('play_hour');
    });
    document.getElementById('pauseBtn').addEventListener('click', () => {
      setSimulationMode('stop', cy, updateInfo);
      setSimState('pause');
    });
    document.getElementById('resetButton').addEventListener('click', () => {
      if (uiMode !== 'simulate') return;
      resetSimulation();
      setSimState('pause');
    });
    document.getElementById('csvButton').addEventListener('click', () => {
      const csvButton = document.getElementById('csvButton');
      if (csvButton.disabled || csvButton.classList.contains('deactivated')) {
        return; // Don't do anything if button is disabled
      }
      
      if (window.generateCSV) {
        window.generateCSV();
      } else {
        console.error('CSV generation function not available.');
      }
    });
  
    // on page load, restore last UI mode but always stay paused
    window.addEventListener('DOMContentLoaded', () => {
      simulationMode = 'stop';
      // restore build vs. simulate
      const savedMode = localStorage.getItem('uiMode');
      if (savedMode === 'simulate') {
        setUIMode('simulate');
      } else {
        setUIMode('build');
      }
      // force pause
      setSimState('pause');
      // ensure no simulation runs until user clicks Play
      setSimulationMode('stop', cy, updateInfo);
      
      // Initialize CSV button state
      if (window.updateCSVButtonState) {
        window.updateCSVButtonState();
      }
    });
  </script>
  


  <!-- Cytoscape container: full browser width -->
  <div id="cy"></div>
	  
  <!-- Info area - Edges Data (Collapsible) -->
  <div class="collapsible-container">
    <div class="collapsible-header">
      <div id="simulation-summary" style="font-size: 0.9em; color: #666; margin-top: 5px;">
        Total Gas Volume: 0.00 Ã— 10â¶ mÂ³ | Inputs: 0 mÂ³/h, Outputs: 0 mÂ³/h | Simulation: 0 h 0 m 0 s
      </div>
      <span class="collapsible-toggle">â–¼</span>
    </div>
    <div class="collapsible-content">
      <div id="info-edges">
        <!-- Edges table will be injected here -->
      </div>
    </div>
  </div>

  <!-- Info area - Nodes Data (Collapsible) -->
  <div class="collapsible-container">
    <div class="collapsible-header">
      <h3> Nodes Data & Gas Injection Points</h3>
      <span class="collapsible-toggle">â–¼</span>
    </div>
    <div class="collapsible-content">
      <div id="info-nodes">
        <!-- Nodes table will be injected here -->
      </div>
    </div>
  </div>
	
<!-- Scenario script UI (collapsible) -->
<div class="collapsible-container">
  <div class="collapsible-header">
    <h3> Scenario Script & Automation</h3>
    <span class="collapsible-toggle">â–¼</span>
  </div>
  <div class="collapsible-content">
    <div class="script-content">
      <textarea id="scriptInput" rows="8"
        placeholder="HH:MM:SS or condition , action
00:01:00, n0.injection = 100  # injection in mÂ³/hour
n0.pressure > 0.1, n0.injection = 200  # injection in mÂ³/hour
n1.pressure > 10, n1_n3.disable = true
0:00:00, n0.pressure = 22
05:00:01, n0.pressureSet = true
99:00:45, n2.pressure = 7.5
105:00:46, n2.pressureSet = true
n3.flow < -5, n3_n0.reverse = true  # flow in mÂ³/hour
n0_n2.flow > 12, n0_n2.disable = true  # flow in mÂ³/hour"></textarea>

      <pre id="scriptStatus"></pre>
    </div>
  </div>
</div>

<script src="../js/script_engine.js"></script>


  <footer  class="container" style="margin-top: 5px; font-size: 0.9em;">
    <h2>Wie simuliert man GasflÃ¼sse in Pipelines?</h2>
    <p>Im Erstellungsmodus erstellen Sie Ihr Netzwerk, fÃ¼gen Knoten und Rohre hinzu und legen Grenzen fest. Legen Sie Injektionen oder Entnahmen an Knoten fest oder fixieren Sie den Druck an einem beliebigen Punkt. Generieren Sie bei Bedarf ein zufÃ¤lliges Netzwerk. Im Simulationsmodus starten Sie die Simulation, wÃ¤hlen eine von drei Geschwindigkeiten, pausieren oder setzen zurÃ¼ck. Laden Sie Ergebnisse als CSV-Log herunter. Verwenden Sie das Szenario-Skript, um Aktionen nach Zeit oder Bedingungen auszulÃ¶sen. ÃœberprÃ¼fen Sie Eingaben und Ausgaben in Knotendaten und Gaseinspeisepunkten. Speichern, exportieren und importieren Sie Ihr Netzwerk.</p>
    <p><strong>Haftungsausschluss:</strong> Dieser Gasfluss-Simulator wird nur fÃ¼r SchÃ¤tzungs- und Informationszwecke bereitgestellt. Die Berechnungen dieses Tools basieren auf allgemeinen Annahmen und spiegeln mÃ¶glicherweise nicht die tatsÃ¤chlichen Betriebsbedingungen wider. Obwohl Anstrengungen unternommen wurden, um Genauigkeit sicherzustellen, geben wir keine Garantien und Ã¼bernehmen keine Haftung fÃ¼r Fehler oder Entscheidungen, die auf den Ergebnissen basieren. Konsultieren Sie immer einen qualifizierten Ingenieur oder technischen Experten, bevor Sie betriebliche Entscheidungen treffen.</p>
  </footer>
  
  <script src="../js/csv_logger.js"></script>
  <script src="../js/random_generator.js"></script>
  <script src="../js/graph_io.js"></script>
  <script src="../js/formulas.js"></script>
  <script src="../js/simulation.js"></script>
  <script src="../js/ui.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Cookie Consent -->
  <script src="../js/cookies.js"></script>

<!-- Help Modal (iframe-based, loads help.html) -->
<div id="helpModalContainer" class="modal" style="display:none;">
  <div class="modal-content" style="padding:0; max-width:700px; width:90vw; max-height:500px; height:80vh;">
    <iframe
      id="helpIframe"
      src="help.html"
      style="width:100%; height:100%; border:none;">
    </iframe>
  </div>
</div>

<script>
  const helpButton = document.getElementById('helpButton');
  const helpModalContainer = document.getElementById('helpModalContainer');

  // Close on message from iframe
  window.addEventListener('message', event => {
    if (event.data?.type === 'closeHelpModal') {
      helpModalContainer.style.display = 'none';
    }
  });

  helpButton.addEventListener('click', () => {
    // Only pause simulation if we're already in simulate mode
    if (uiMode === 'simulate') {
      if (typeof setSimulationMode === 'function') {
        setSimulationMode('stop', cy, updateInfo);
      }
      setSimState('pause');
      // ensure the simulate button stays active
      setUIMode('simulate');
    }
    // Show the help overlay regardless of mode
    helpModalContainer.style.display = 'block';
  });
</script>
